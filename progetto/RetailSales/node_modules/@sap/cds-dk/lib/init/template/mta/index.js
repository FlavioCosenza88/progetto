const { join } = require('path');
const cds = require('../../../cds')
const { exists } = cds.utils
const { copyFiles } = require('../../util/template')
const { readProject } = require('../../util/projectReader');

module.exports = class MtaTemplate extends require('../templateBase') {

    static hasFacet(_, options) {
        if (!options?.add.has('mta') && options?.add.has('helm')) return false
        return exists('mta.yaml')
    }

    async run() {
        const projectDescriptor = await readProject()
        if (!exists('mta.yaml')) {
            await copyFiles(join(__dirname, 'files'), cds.root, projectDescriptor);
        }

        // Re-applying the dependent merging part of other facets if necessary.
        const dependentFacets = ['approuter', 'hana', 'xsuaa', 'multitenancy', 'extensibility', 'enterprise-messaging', 'enterprise-messaging-shared', 'redis-messaging']
        for (const facet of dependentFacets) {
            const Template = require('../'+facet)
            const template = new Template(this.generator)
            if (Template.hasFacet(await this.getEnv(), this.options)) await template.runDependentMerging()
        }
    }
}
