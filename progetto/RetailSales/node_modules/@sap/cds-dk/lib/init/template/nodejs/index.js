const { join, relative } = require('path');
const cds = require('../../../cds')
const { mkdirp } = cds.utils
const { COMMAND_ADD, OPTION_JAVA, OPTION_NODEJS, URLS } = require('../../constants')
const { copyFiles } = require('../../util/template')
const LOG = console

module.exports = class NodejsTemplate extends require('../templateBase') {

    static hasFacet() {
        // TODO: Implement
        //return this.language === P_LANGUAGE_NODEJS
    }

    async canRun() {
        if (this.options._cmd === COMMAND_ADD) {
            throw new Error(`You can't change the type of an existing project.`);
        }

        if (this.options.add.has(OPTION_JAVA)) {
            throw new Error(`Only one runtime per project is supported. Specify either ${OPTION_JAVA} or ${OPTION_NODEJS}.`);
        }

        return true;
    }

    async run() {
        const env = await this.getEnv();
        const { projectPath, projectName } = this
        await copyFiles(join(__dirname, 'files'), projectPath, { projectName }, this.options.force)

        await mkdirp(env.folders.db);
        await mkdirp(env.folders.srv);
        await mkdirp(env.folders.app);
    }

    async finalize() {
        const relativeProjectPath = relative(this.cwd, cds.root);
        if (relativeProjectPath && relativeProjectPath !== '.') {
            LOG.info(`Continue with 'cd ${relativeProjectPath}'`);
        }

        LOG.info(`Find samples on ${URLS.SAMPLES}`);
        LOG.info(`Learn about next steps at ${URLS.CAPIRE}`);
    }
}
