const { join } = require('path')
const cds = require('../../../cds'), { read } = cds.utils
const { readProject } = require('../../util/projectReader')
const { mergeJSON } = require('../../util/merge')

module.exports = class FileBasedMessagingTemplate extends require('../templateBase') {

  async canRun() {
    const projectDescriptor = await readProject(this.options)
    const { isJava } = projectDescriptor.cap
    if (isJava) throw `'cds add file-based-messaging' is not available for Java yet`
    return true
  }

  static hasFacet(env) {
    return env.requires?.messaging?.kind === 'file-based-messaging'
  }

  async run() {
    const projectDescriptor = await readProject(this.options)
    const { configFile } = projectDescriptor.cap
    projectDescriptor.cap.shortcut = !(await read(configFile)).cds?.requires?.messaging?.kind
    await mergeJSON(configFile, join(__dirname, 'files', 'package.json.hbs'), projectDescriptor)
  }
}
